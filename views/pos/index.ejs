<!-- POS Main View -->
<% if (success && success.length) { %>
  <div class="alert alert-success"><%= success[0] %></div>
<% } %>
<% if (error && error.length) { %>
  <% error.forEach(function(msg) { %>
    <div class="alert alert-danger"><%= msg %></div>
  <% }); %>
<% } %>
<div class="mb-3">
  <label>Customer</label>
  <select id="customer-select" class="form-select" name="customer_id" style="width:100%">
    <option value="">Select Customer</option>
    <% customers.forEach(c => { %>
      <option value="<%= c.id %>"><%= c.name %> - <%= c.phone %></option>
    <% }) %>
  </select>
  <input type="hidden" name="customer_id" id="selectedCustomerId">
  <button class="btn btn-sm btn-outline-primary mt-2" data-bs-toggle="modal" data-bs-target="#addCustomerModal">+ Add New</button>
</div>

<!-- Add Customer Modal -->
<div class="modal fade" id="addCustomerModal" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content" id="add-customer-form">
      <div class="modal-header">
        <h5>Add Customer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input name="name" class="form-control mb-2" placeholder="Name" required>
        <input name="phone" class="form-control mb-2" placeholder="Phone" required>
        <input type="text" name="email" class="form-control" placeholder="Email">
         <textarea name="address" class="form-control"></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn btn-success" type="submit">Save</button>
      </div>
    </form>
  </div>
</div>

<div class="container-fluid mt-3">
  <div class="row">
    <!-- Product List -->
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">Products</div>
        <div class="card-body d-flex flex-wrap gap-2">
          <% products.forEach(product => { %>
            <button class="btn btn-outline-primary" onclick="addToCart('<%= product.id %>', '<%= product.name %>', <%= product.price %>)">
              <%= product.name %><br>â‚¹<%= product.price %><br>
              <% if ( product.image ) { %>
              <img src="/uploads/products/<%= product.image %>" width="100" />
              <% } else { %>
               <img src="/uploads/products/no-image.png" alt="No Image" width="100"/>
            <%  } %>
            </button>
          <% }) %>
        </div>
      </div>
    </div>

    <!-- Cart -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header d-flex justify-content-between">
          Cart
          <button class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#addCustomerModal">+ Customer</button>
        </div>
      

        <ul class="list-group" id="cart-items"></ul>


        <div class="card-footer">
          <div class="text-end fw-bold mt-2">
  Total: â‚¹<span id="cart-total">0.00</span>
</div>
          <form action="/pos/checkout" method="POST">
            <input type="hidden" name="customerId" id="sID" value="">
            <button type="submit" class="btn btn-success w-100">Checkout</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function addToCart(id, name, price) {
  fetch('/pos/add-to-cart', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id, name, price })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) updateCart(data.cart);
  });
}
function updateCart(cart) {
  const list = document.getElementById('cart-items');
  list.innerHTML = '';
  for (const [id, item] of Object.entries(cart.items)) {
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center';
    li.innerHTML = `
      ${item.name} x ${item.qty}
      <div>
        <button class="btn btn-sm btn-outline-dark" onclick="changeQty('${id}', 'decrease')">-</button>
        <button class="btn btn-sm btn-outline-dark" onclick="changeQty('${id}', 'increase')">+</button>
        <button class="btn btn-sm btn-danger" onclick="removeFromCart('${id}')">ðŸ—‘</button>
      </div>`;
    list.appendChild(li);
  }
  document.getElementById('cart-total').innerText = cart.totalPrice.toFixed(2);
}

function changeQty(id, action) {
  fetch('/pos/update-cart', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id, action })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) updateCart(data.cart);
  });
}
function removeFromCart(id) {
  fetch('/pos/remove-from-cart', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) updateCart(data.cart);
  });
}

$(document).ready(function() {
  $('#customer-select').select2({
    placeholder: "Select Customer",
    allowClear: true,
    width: '100%'
  }).on('change', function () {
    $('#selectedCustomerId').val(this.value);
  });

  // Save customer via AJAX
  $('#add-customer-form').on('submit', function (e) {
  e.preventDefault();
  $.ajax({
    type: 'POST',
    url: '/customers/ajaxadd',
    data: $(this).serialize(),
    success: function (response) {
      if (response.success) {
        // Close modal
        $('#addCustomerModal').modal('hide');

        // Add to Select2
        const customerId =response.customer.id;
        const newOption = new Option(response.customer.display, response.customer.id, true, true);
        $('#customer-select').append(newOption).trigger('change');
        $('#sID').val(customerId);
        $('#add-customer-form')[0].reset();
      } else {
        alert(response.message);
      }
    },
    error: function () {
      alert('Something went wrong.');
    }
  });
});




});

$('#customer-select').on('change', function () {
    $('#sID').val($(this).val());
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    fetch('/pos/get-cart')
      .then(res => res.json())
      .then(data => {
        if (data.cart) updateCart(data.cart);
      });
  });
</script>




